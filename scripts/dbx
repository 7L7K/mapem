#!/bin/bash

echo "üßπ Fixing unclosed SessionLocal() usage across backend..."

# Dependencies check
if ! command -v rg &> /dev/null; then
  echo "‚ùå ripgrep (rg) is not installed. Run: brew install ripgrep"
  exit 1
fi
if ! command -v gsed &> /dev/null; then
  echo "‚ùå gnu-sed (gsed) is not installed. Run: brew install gnu-sed"
  exit 1
fi

# Find all files with raw SessionLocal() usage
FILES=$(rg --files-with-matches 'SessionLocal\(\)' backend)

if [ -z "$FILES" ]; then
  echo "‚úÖ No files need patching. You're clean."
  exit 0
fi

# Backup originals
echo "üì¶ Backing up original files..."
for f in $FILES; do
  cp "$f" "$f.bak.$(date +%s)"
done

# Inject context-managed usage
echo "üîß Patching session usage..."
for f in $FILES; do
  gsed -i '/SessionLocal()/!b;n;s/^/    with SessionLocal() as session:\n        /' "$f"
done

echo "‚úÖ All session usages patched with context manager!"
